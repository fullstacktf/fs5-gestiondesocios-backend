<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Source: gorm.go in package gorm.io/gorm</title>
<link href="../../../css/light-v0.1.6.css" rel="stylesheet">
<script src="../../../jvs/golds-v0.1.6.js"></script>
<body><div>

<pre id="header"><code><span class="title">Source File</span>
	gorm.go

<span class="title">Belonging Package</span>
	<a href="../../../pkg/gorm.io/gorm.html">gorm.io/gorm</a>
</code></pre>

<pre class="line-numbers">
<span class="codeline" id="line-1"><code>package gorm</code></span>
<span class="codeline" id="line-2"><code></code></span>
<span class="codeline" id="line-3"><code>import (</code></span>
<span class="codeline" id="line-4"><code>	"context"</code></span>
<span class="codeline" id="line-5"><code>	"database/sql"</code></span>
<span class="codeline" id="line-6"><code>	"errors"</code></span>
<span class="codeline" id="line-7"><code>	"fmt"</code></span>
<span class="codeline" id="line-8"><code>	"sync"</code></span>
<span class="codeline" id="line-9"><code>	"time"</code></span>
<span class="codeline" id="line-10"><code></code></span>
<span class="codeline" id="line-11"><code>	"gorm.io/gorm/clause"</code></span>
<span class="codeline" id="line-12"><code>	"gorm.io/gorm/logger"</code></span>
<span class="codeline" id="line-13"><code>	"gorm.io/gorm/schema"</code></span>
<span class="codeline" id="line-14"><code>)</code></span>
<span class="codeline" id="line-15"><code></code></span>
<span class="codeline" id="line-16"><code>// Config GORM config</code></span>
<span class="codeline" id="line-17"><code>type Config struct {</code></span>
<span class="codeline" id="line-18"><code>	// GORM perform single create, update, delete operations in transactions by default to ensure database data integrity</code></span>
<span class="codeline" id="line-19"><code>	// You can disable it by setting `SkipDefaultTransaction` to true</code></span>
<span class="codeline" id="line-20"><code>	SkipDefaultTransaction bool</code></span>
<span class="codeline" id="line-21"><code>	// NamingStrategy tables, columns naming strategy</code></span>
<span class="codeline" id="line-22"><code>	NamingStrategy schema.Namer</code></span>
<span class="codeline" id="line-23"><code>	// FullSaveAssociations full save associations</code></span>
<span class="codeline" id="line-24"><code>	FullSaveAssociations bool</code></span>
<span class="codeline" id="line-25"><code>	// Logger</code></span>
<span class="codeline" id="line-26"><code>	Logger logger.Interface</code></span>
<span class="codeline" id="line-27"><code>	// NowFunc the function to be used when creating a new timestamp</code></span>
<span class="codeline" id="line-28"><code>	NowFunc func() time.Time</code></span>
<span class="codeline" id="line-29"><code>	// DryRun generate sql without execute</code></span>
<span class="codeline" id="line-30"><code>	DryRun bool</code></span>
<span class="codeline" id="line-31"><code>	// PrepareStmt executes the given query in cached statement</code></span>
<span class="codeline" id="line-32"><code>	PrepareStmt bool</code></span>
<span class="codeline" id="line-33"><code>	// DisableAutomaticPing</code></span>
<span class="codeline" id="line-34"><code>	DisableAutomaticPing bool</code></span>
<span class="codeline" id="line-35"><code>	// DisableForeignKeyConstraintWhenMigrating</code></span>
<span class="codeline" id="line-36"><code>	DisableForeignKeyConstraintWhenMigrating bool</code></span>
<span class="codeline" id="line-37"><code>	// AllowGlobalUpdate allow global update</code></span>
<span class="codeline" id="line-38"><code>	AllowGlobalUpdate bool</code></span>
<span class="codeline" id="line-39"><code></code></span>
<span class="codeline" id="line-40"><code>	// ClauseBuilders clause builder</code></span>
<span class="codeline" id="line-41"><code>	ClauseBuilders map[string]clause.ClauseBuilder</code></span>
<span class="codeline" id="line-42"><code>	// ConnPool db conn pool</code></span>
<span class="codeline" id="line-43"><code>	ConnPool ConnPool</code></span>
<span class="codeline" id="line-44"><code>	// Dialector database dialector</code></span>
<span class="codeline" id="line-45"><code>	Dialector</code></span>
<span class="codeline" id="line-46"><code>	// Plugins registered plugins</code></span>
<span class="codeline" id="line-47"><code>	Plugins map[string]Plugin</code></span>
<span class="codeline" id="line-48"><code></code></span>
<span class="codeline" id="line-49"><code>	callbacks  *callbacks</code></span>
<span class="codeline" id="line-50"><code>	cacheStore *sync.Map</code></span>
<span class="codeline" id="line-51"><code>}</code></span>
<span class="codeline" id="line-52"><code></code></span>
<span class="codeline" id="line-53"><code>// DB GORM DB definition</code></span>
<span class="codeline" id="line-54"><code>type DB struct {</code></span>
<span class="codeline" id="line-55"><code>	*Config</code></span>
<span class="codeline" id="line-56"><code>	Error        error</code></span>
<span class="codeline" id="line-57"><code>	RowsAffected int64</code></span>
<span class="codeline" id="line-58"><code>	Statement    *Statement</code></span>
<span class="codeline" id="line-59"><code>	clone        int</code></span>
<span class="codeline" id="line-60"><code>}</code></span>
<span class="codeline" id="line-61"><code></code></span>
<span class="codeline" id="line-62"><code>// Session session config when create session with Session() method</code></span>
<span class="codeline" id="line-63"><code>type Session struct {</code></span>
<span class="codeline" id="line-64"><code>	DryRun                 bool</code></span>
<span class="codeline" id="line-65"><code>	PrepareStmt            bool</code></span>
<span class="codeline" id="line-66"><code>	WithConditions         bool</code></span>
<span class="codeline" id="line-67"><code>	SkipDefaultTransaction bool</code></span>
<span class="codeline" id="line-68"><code>	AllowGlobalUpdate      bool</code></span>
<span class="codeline" id="line-69"><code>	FullSaveAssociations   bool</code></span>
<span class="codeline" id="line-70"><code>	Context                context.Context</code></span>
<span class="codeline" id="line-71"><code>	Logger                 logger.Interface</code></span>
<span class="codeline" id="line-72"><code>	NowFunc                func() time.Time</code></span>
<span class="codeline" id="line-73"><code>}</code></span>
<span class="codeline" id="line-74"><code></code></span>
<span class="codeline" id="line-75"><code>// Open initialize db session based on dialector</code></span>
<span class="codeline" id="line-76"><code>func Open(dialector Dialector, config *Config) (db *DB, err error) {</code></span>
<span class="codeline" id="line-77"><code>	if config == nil {</code></span>
<span class="codeline" id="line-78"><code>		config = &amp;Config{}</code></span>
<span class="codeline" id="line-79"><code>	}</code></span>
<span class="codeline" id="line-80"><code></code></span>
<span class="codeline" id="line-81"><code>	if config.NamingStrategy == nil {</code></span>
<span class="codeline" id="line-82"><code>		config.NamingStrategy = schema.NamingStrategy{}</code></span>
<span class="codeline" id="line-83"><code>	}</code></span>
<span class="codeline" id="line-84"><code></code></span>
<span class="codeline" id="line-85"><code>	if config.Logger == nil {</code></span>
<span class="codeline" id="line-86"><code>		config.Logger = logger.Default</code></span>
<span class="codeline" id="line-87"><code>	}</code></span>
<span class="codeline" id="line-88"><code></code></span>
<span class="codeline" id="line-89"><code>	if config.NowFunc == nil {</code></span>
<span class="codeline" id="line-90"><code>		config.NowFunc = func() time.Time { return time.Now().Local() }</code></span>
<span class="codeline" id="line-91"><code>	}</code></span>
<span class="codeline" id="line-92"><code></code></span>
<span class="codeline" id="line-93"><code>	if dialector != nil {</code></span>
<span class="codeline" id="line-94"><code>		config.Dialector = dialector</code></span>
<span class="codeline" id="line-95"><code>	}</code></span>
<span class="codeline" id="line-96"><code></code></span>
<span class="codeline" id="line-97"><code>	if config.Plugins == nil {</code></span>
<span class="codeline" id="line-98"><code>		config.Plugins = map[string]Plugin{}</code></span>
<span class="codeline" id="line-99"><code>	}</code></span>
<span class="codeline" id="line-100"><code></code></span>
<span class="codeline" id="line-101"><code>	if config.cacheStore == nil {</code></span>
<span class="codeline" id="line-102"><code>		config.cacheStore = &amp;sync.Map{}</code></span>
<span class="codeline" id="line-103"><code>	}</code></span>
<span class="codeline" id="line-104"><code></code></span>
<span class="codeline" id="line-105"><code>	db = &amp;DB{Config: config, clone: 1}</code></span>
<span class="codeline" id="line-106"><code></code></span>
<span class="codeline" id="line-107"><code>	db.callbacks = initializeCallbacks(db)</code></span>
<span class="codeline" id="line-108"><code></code></span>
<span class="codeline" id="line-109"><code>	if config.ClauseBuilders == nil {</code></span>
<span class="codeline" id="line-110"><code>		config.ClauseBuilders = map[string]clause.ClauseBuilder{}</code></span>
<span class="codeline" id="line-111"><code>	}</code></span>
<span class="codeline" id="line-112"><code></code></span>
<span class="codeline" id="line-113"><code>	if config.Dialector != nil {</code></span>
<span class="codeline" id="line-114"><code>		err = config.Dialector.Initialize(db)</code></span>
<span class="codeline" id="line-115"><code>	}</code></span>
<span class="codeline" id="line-116"><code></code></span>
<span class="codeline" id="line-117"><code>	preparedStmt := &amp;PreparedStmtDB{</code></span>
<span class="codeline" id="line-118"><code>		ConnPool:    db.ConnPool,</code></span>
<span class="codeline" id="line-119"><code>		Stmts:       map[string]*sql.Stmt{},</code></span>
<span class="codeline" id="line-120"><code>		Mux:         &amp;sync.RWMutex{},</code></span>
<span class="codeline" id="line-121"><code>		PreparedSQL: make([]string, 0, 100),</code></span>
<span class="codeline" id="line-122"><code>	}</code></span>
<span class="codeline" id="line-123"><code>	db.cacheStore.Store("preparedStmt", preparedStmt)</code></span>
<span class="codeline" id="line-124"><code></code></span>
<span class="codeline" id="line-125"><code>	if config.PrepareStmt {</code></span>
<span class="codeline" id="line-126"><code>		db.ConnPool = preparedStmt</code></span>
<span class="codeline" id="line-127"><code>	}</code></span>
<span class="codeline" id="line-128"><code></code></span>
<span class="codeline" id="line-129"><code>	db.Statement = &amp;Statement{</code></span>
<span class="codeline" id="line-130"><code>		DB:       db,</code></span>
<span class="codeline" id="line-131"><code>		ConnPool: db.ConnPool,</code></span>
<span class="codeline" id="line-132"><code>		Context:  context.Background(),</code></span>
<span class="codeline" id="line-133"><code>		Clauses:  map[string]clause.Clause{},</code></span>
<span class="codeline" id="line-134"><code>	}</code></span>
<span class="codeline" id="line-135"><code></code></span>
<span class="codeline" id="line-136"><code>	if err == nil &amp;&amp; !config.DisableAutomaticPing {</code></span>
<span class="codeline" id="line-137"><code>		if pinger, ok := db.ConnPool.(interface{ Ping() error }); ok {</code></span>
<span class="codeline" id="line-138"><code>			err = pinger.Ping()</code></span>
<span class="codeline" id="line-139"><code>		}</code></span>
<span class="codeline" id="line-140"><code>	}</code></span>
<span class="codeline" id="line-141"><code></code></span>
<span class="codeline" id="line-142"><code>	if err != nil {</code></span>
<span class="codeline" id="line-143"><code>		config.Logger.Error(context.Background(), "failed to initialize database, got error %v", err)</code></span>
<span class="codeline" id="line-144"><code>	}</code></span>
<span class="codeline" id="line-145"><code></code></span>
<span class="codeline" id="line-146"><code>	return</code></span>
<span class="codeline" id="line-147"><code>}</code></span>
<span class="codeline" id="line-148"><code></code></span>
<span class="codeline" id="line-149"><code>// Session create new db session</code></span>
<span class="codeline" id="line-150"><code>func (db *DB) Session(config *Session) *DB {</code></span>
<span class="codeline" id="line-151"><code>	var (</code></span>
<span class="codeline" id="line-152"><code>		txConfig = *db.Config</code></span>
<span class="codeline" id="line-153"><code>		tx       = &amp;DB{</code></span>
<span class="codeline" id="line-154"><code>			Config:    &amp;txConfig,</code></span>
<span class="codeline" id="line-155"><code>			Statement: db.Statement,</code></span>
<span class="codeline" id="line-156"><code>			clone:     1,</code></span>
<span class="codeline" id="line-157"><code>		}</code></span>
<span class="codeline" id="line-158"><code>	)</code></span>
<span class="codeline" id="line-159"><code></code></span>
<span class="codeline" id="line-160"><code>	if config.SkipDefaultTransaction {</code></span>
<span class="codeline" id="line-161"><code>		tx.Config.SkipDefaultTransaction = true</code></span>
<span class="codeline" id="line-162"><code>	}</code></span>
<span class="codeline" id="line-163"><code></code></span>
<span class="codeline" id="line-164"><code>	if config.AllowGlobalUpdate {</code></span>
<span class="codeline" id="line-165"><code>		txConfig.AllowGlobalUpdate = true</code></span>
<span class="codeline" id="line-166"><code>	}</code></span>
<span class="codeline" id="line-167"><code></code></span>
<span class="codeline" id="line-168"><code>	if config.FullSaveAssociations {</code></span>
<span class="codeline" id="line-169"><code>		txConfig.FullSaveAssociations = true</code></span>
<span class="codeline" id="line-170"><code>	}</code></span>
<span class="codeline" id="line-171"><code></code></span>
<span class="codeline" id="line-172"><code>	if config.Context != nil {</code></span>
<span class="codeline" id="line-173"><code>		tx.Statement = tx.Statement.clone()</code></span>
<span class="codeline" id="line-174"><code>		tx.Statement.DB = tx</code></span>
<span class="codeline" id="line-175"><code>		tx.Statement.Context = config.Context</code></span>
<span class="codeline" id="line-176"><code>	}</code></span>
<span class="codeline" id="line-177"><code></code></span>
<span class="codeline" id="line-178"><code>	if config.PrepareStmt {</code></span>
<span class="codeline" id="line-179"><code>		if v, ok := db.cacheStore.Load("preparedStmt"); ok {</code></span>
<span class="codeline" id="line-180"><code>			tx.Statement = tx.Statement.clone()</code></span>
<span class="codeline" id="line-181"><code>			preparedStmt := v.(*PreparedStmtDB)</code></span>
<span class="codeline" id="line-182"><code>			tx.Statement.ConnPool = &amp;PreparedStmtDB{</code></span>
<span class="codeline" id="line-183"><code>				ConnPool: db.Config.ConnPool,</code></span>
<span class="codeline" id="line-184"><code>				Mux:      preparedStmt.Mux,</code></span>
<span class="codeline" id="line-185"><code>				Stmts:    preparedStmt.Stmts,</code></span>
<span class="codeline" id="line-186"><code>			}</code></span>
<span class="codeline" id="line-187"><code>			txConfig.ConnPool = tx.Statement.ConnPool</code></span>
<span class="codeline" id="line-188"><code>			txConfig.PrepareStmt = true</code></span>
<span class="codeline" id="line-189"><code>		}</code></span>
<span class="codeline" id="line-190"><code>	}</code></span>
<span class="codeline" id="line-191"><code></code></span>
<span class="codeline" id="line-192"><code>	if config.WithConditions {</code></span>
<span class="codeline" id="line-193"><code>		tx.clone = 2</code></span>
<span class="codeline" id="line-194"><code>	}</code></span>
<span class="codeline" id="line-195"><code></code></span>
<span class="codeline" id="line-196"><code>	if config.DryRun {</code></span>
<span class="codeline" id="line-197"><code>		tx.Config.DryRun = true</code></span>
<span class="codeline" id="line-198"><code>	}</code></span>
<span class="codeline" id="line-199"><code></code></span>
<span class="codeline" id="line-200"><code>	if config.Logger != nil {</code></span>
<span class="codeline" id="line-201"><code>		tx.Config.Logger = config.Logger</code></span>
<span class="codeline" id="line-202"><code>	}</code></span>
<span class="codeline" id="line-203"><code></code></span>
<span class="codeline" id="line-204"><code>	if config.NowFunc != nil {</code></span>
<span class="codeline" id="line-205"><code>		tx.Config.NowFunc = config.NowFunc</code></span>
<span class="codeline" id="line-206"><code>	}</code></span>
<span class="codeline" id="line-207"><code></code></span>
<span class="codeline" id="line-208"><code>	return tx</code></span>
<span class="codeline" id="line-209"><code>}</code></span>
<span class="codeline" id="line-210"><code></code></span>
<span class="codeline" id="line-211"><code>// WithContext change current instance db's context to ctx</code></span>
<span class="codeline" id="line-212"><code>func (db *DB) WithContext(ctx context.Context) *DB {</code></span>
<span class="codeline" id="line-213"><code>	return db.Session(&amp;Session{WithConditions: true, Context: ctx})</code></span>
<span class="codeline" id="line-214"><code>}</code></span>
<span class="codeline" id="line-215"><code></code></span>
<span class="codeline" id="line-216"><code>// Debug start debug mode</code></span>
<span class="codeline" id="line-217"><code>func (db *DB) Debug() (tx *DB) {</code></span>
<span class="codeline" id="line-218"><code>	return db.Session(&amp;Session{</code></span>
<span class="codeline" id="line-219"><code>		WithConditions: true,</code></span>
<span class="codeline" id="line-220"><code>		Logger:         db.Logger.LogMode(logger.Info),</code></span>
<span class="codeline" id="line-221"><code>	})</code></span>
<span class="codeline" id="line-222"><code>}</code></span>
<span class="codeline" id="line-223"><code></code></span>
<span class="codeline" id="line-224"><code>// Set store value with key into current db instance's context</code></span>
<span class="codeline" id="line-225"><code>func (db *DB) Set(key string, value interface{}) *DB {</code></span>
<span class="codeline" id="line-226"><code>	tx := db.getInstance()</code></span>
<span class="codeline" id="line-227"><code>	tx.Statement.Settings.Store(key, value)</code></span>
<span class="codeline" id="line-228"><code>	return tx</code></span>
<span class="codeline" id="line-229"><code>}</code></span>
<span class="codeline" id="line-230"><code></code></span>
<span class="codeline" id="line-231"><code>// Get get value with key from current db instance's context</code></span>
<span class="codeline" id="line-232"><code>func (db *DB) Get(key string) (interface{}, bool) {</code></span>
<span class="codeline" id="line-233"><code>	return db.Statement.Settings.Load(key)</code></span>
<span class="codeline" id="line-234"><code>}</code></span>
<span class="codeline" id="line-235"><code></code></span>
<span class="codeline" id="line-236"><code>// InstanceSet store value with key into current db instance's context</code></span>
<span class="codeline" id="line-237"><code>func (db *DB) InstanceSet(key string, value interface{}) *DB {</code></span>
<span class="codeline" id="line-238"><code>	tx := db.getInstance()</code></span>
<span class="codeline" id="line-239"><code>	tx.Statement.Settings.Store(fmt.Sprintf("%p", tx.Statement)+key, value)</code></span>
<span class="codeline" id="line-240"><code>	return tx</code></span>
<span class="codeline" id="line-241"><code>}</code></span>
<span class="codeline" id="line-242"><code></code></span>
<span class="codeline" id="line-243"><code>// InstanceGet get value with key from current db instance's context</code></span>
<span class="codeline" id="line-244"><code>func (db *DB) InstanceGet(key string) (interface{}, bool) {</code></span>
<span class="codeline" id="line-245"><code>	return db.Statement.Settings.Load(fmt.Sprintf("%p", db.Statement) + key)</code></span>
<span class="codeline" id="line-246"><code>}</code></span>
<span class="codeline" id="line-247"><code></code></span>
<span class="codeline" id="line-248"><code>// Callback returns callback manager</code></span>
<span class="codeline" id="line-249"><code>func (db *DB) Callback() *callbacks {</code></span>
<span class="codeline" id="line-250"><code>	return db.callbacks</code></span>
<span class="codeline" id="line-251"><code>}</code></span>
<span class="codeline" id="line-252"><code></code></span>
<span class="codeline" id="line-253"><code>// AddError add error to db</code></span>
<span class="codeline" id="line-254"><code>func (db *DB) AddError(err error) error {</code></span>
<span class="codeline" id="line-255"><code>	if db.Error == nil {</code></span>
<span class="codeline" id="line-256"><code>		db.Error = err</code></span>
<span class="codeline" id="line-257"><code>	} else if err != nil {</code></span>
<span class="codeline" id="line-258"><code>		db.Error = fmt.Errorf("%v; %w", db.Error, err)</code></span>
<span class="codeline" id="line-259"><code>	}</code></span>
<span class="codeline" id="line-260"><code>	return db.Error</code></span>
<span class="codeline" id="line-261"><code>}</code></span>
<span class="codeline" id="line-262"><code></code></span>
<span class="codeline" id="line-263"><code>// DB returns `*sql.DB`</code></span>
<span class="codeline" id="line-264"><code>func (db *DB) DB() (*sql.DB, error) {</code></span>
<span class="codeline" id="line-265"><code>	connPool := db.ConnPool</code></span>
<span class="codeline" id="line-266"><code></code></span>
<span class="codeline" id="line-267"><code>	if stmtDB, ok := connPool.(*PreparedStmtDB); ok {</code></span>
<span class="codeline" id="line-268"><code>		connPool = stmtDB.ConnPool</code></span>
<span class="codeline" id="line-269"><code>	}</code></span>
<span class="codeline" id="line-270"><code></code></span>
<span class="codeline" id="line-271"><code>	if sqldb, ok := connPool.(*sql.DB); ok {</code></span>
<span class="codeline" id="line-272"><code>		return sqldb, nil</code></span>
<span class="codeline" id="line-273"><code>	}</code></span>
<span class="codeline" id="line-274"><code></code></span>
<span class="codeline" id="line-275"><code>	return nil, errors.New("invalid db")</code></span>
<span class="codeline" id="line-276"><code>}</code></span>
<span class="codeline" id="line-277"><code></code></span>
<span class="codeline" id="line-278"><code>func (db *DB) getInstance() *DB {</code></span>
<span class="codeline" id="line-279"><code>	if db.clone &gt; 0 {</code></span>
<span class="codeline" id="line-280"><code>		tx := &amp;DB{Config: db.Config}</code></span>
<span class="codeline" id="line-281"><code></code></span>
<span class="codeline" id="line-282"><code>		if db.clone == 1 {</code></span>
<span class="codeline" id="line-283"><code>			// clone with new statement</code></span>
<span class="codeline" id="line-284"><code>			tx.Statement = &amp;Statement{</code></span>
<span class="codeline" id="line-285"><code>				DB:       tx,</code></span>
<span class="codeline" id="line-286"><code>				ConnPool: db.Statement.ConnPool,</code></span>
<span class="codeline" id="line-287"><code>				Context:  db.Statement.Context,</code></span>
<span class="codeline" id="line-288"><code>				Clauses:  map[string]clause.Clause{},</code></span>
<span class="codeline" id="line-289"><code>			}</code></span>
<span class="codeline" id="line-290"><code>		} else {</code></span>
<span class="codeline" id="line-291"><code>			// with clone statement</code></span>
<span class="codeline" id="line-292"><code>			tx.Statement = db.Statement.clone()</code></span>
<span class="codeline" id="line-293"><code>			tx.Statement.DB = tx</code></span>
<span class="codeline" id="line-294"><code>		}</code></span>
<span class="codeline" id="line-295"><code></code></span>
<span class="codeline" id="line-296"><code>		return tx</code></span>
<span class="codeline" id="line-297"><code>	}</code></span>
<span class="codeline" id="line-298"><code></code></span>
<span class="codeline" id="line-299"><code>	return db</code></span>
<span class="codeline" id="line-300"><code>}</code></span>
<span class="codeline" id="line-301"><code></code></span>
<span class="codeline" id="line-302"><code>func Expr(expr string, args ...interface{}) clause.Expr {</code></span>
<span class="codeline" id="line-303"><code>	return clause.Expr{SQL: expr, Vars: args}</code></span>
<span class="codeline" id="line-304"><code>}</code></span>
<span class="codeline" id="line-305"><code></code></span>
<span class="codeline" id="line-306"><code>func (db *DB) SetupJoinTable(model interface{}, field string, joinTable interface{}) error {</code></span>
<span class="codeline" id="line-307"><code>	var (</code></span>
<span class="codeline" id="line-308"><code>		tx                      = db.getInstance()</code></span>
<span class="codeline" id="line-309"><code>		stmt                    = tx.Statement</code></span>
<span class="codeline" id="line-310"><code>		modelSchema, joinSchema *schema.Schema</code></span>
<span class="codeline" id="line-311"><code>	)</code></span>
<span class="codeline" id="line-312"><code></code></span>
<span class="codeline" id="line-313"><code>	if err := stmt.Parse(model); err == nil {</code></span>
<span class="codeline" id="line-314"><code>		modelSchema = stmt.Schema</code></span>
<span class="codeline" id="line-315"><code>	} else {</code></span>
<span class="codeline" id="line-316"><code>		return err</code></span>
<span class="codeline" id="line-317"><code>	}</code></span>
<span class="codeline" id="line-318"><code></code></span>
<span class="codeline" id="line-319"><code>	if err := stmt.Parse(joinTable); err == nil {</code></span>
<span class="codeline" id="line-320"><code>		joinSchema = stmt.Schema</code></span>
<span class="codeline" id="line-321"><code>	} else {</code></span>
<span class="codeline" id="line-322"><code>		return err</code></span>
<span class="codeline" id="line-323"><code>	}</code></span>
<span class="codeline" id="line-324"><code></code></span>
<span class="codeline" id="line-325"><code>	if relation, ok := modelSchema.Relationships.Relations[field]; ok &amp;&amp; relation.JoinTable != nil {</code></span>
<span class="codeline" id="line-326"><code>		for _, ref := range relation.References {</code></span>
<span class="codeline" id="line-327"><code>			if f := joinSchema.LookUpField(ref.ForeignKey.DBName); f != nil {</code></span>
<span class="codeline" id="line-328"><code>				f.DataType = ref.ForeignKey.DataType</code></span>
<span class="codeline" id="line-329"><code>				f.GORMDataType = ref.ForeignKey.GORMDataType</code></span>
<span class="codeline" id="line-330"><code>				if f.Size == 0 {</code></span>
<span class="codeline" id="line-331"><code>					f.Size = ref.ForeignKey.Size</code></span>
<span class="codeline" id="line-332"><code>				}</code></span>
<span class="codeline" id="line-333"><code>				ref.ForeignKey = f</code></span>
<span class="codeline" id="line-334"><code>			} else {</code></span>
<span class="codeline" id="line-335"><code>				return fmt.Errorf("missing field %v for join table", ref.ForeignKey.DBName)</code></span>
<span class="codeline" id="line-336"><code>			}</code></span>
<span class="codeline" id="line-337"><code>		}</code></span>
<span class="codeline" id="line-338"><code></code></span>
<span class="codeline" id="line-339"><code>		for name, rel := range relation.JoinTable.Relationships.Relations {</code></span>
<span class="codeline" id="line-340"><code>			if _, ok := joinSchema.Relationships.Relations[name]; !ok {</code></span>
<span class="codeline" id="line-341"><code>				rel.Schema = joinSchema</code></span>
<span class="codeline" id="line-342"><code>				joinSchema.Relationships.Relations[name] = rel</code></span>
<span class="codeline" id="line-343"><code>			}</code></span>
<span class="codeline" id="line-344"><code>		}</code></span>
<span class="codeline" id="line-345"><code></code></span>
<span class="codeline" id="line-346"><code>		relation.JoinTable = joinSchema</code></span>
<span class="codeline" id="line-347"><code>	} else {</code></span>
<span class="codeline" id="line-348"><code>		return fmt.Errorf("failed to found relation: %v", field)</code></span>
<span class="codeline" id="line-349"><code>	}</code></span>
<span class="codeline" id="line-350"><code></code></span>
<span class="codeline" id="line-351"><code>	return nil</code></span>
<span class="codeline" id="line-352"><code>}</code></span>
<span class="codeline" id="line-353"><code></code></span>
<span class="codeline" id="line-354"><code>func (db *DB) Use(plugin Plugin) (err error) {</code></span>
<span class="codeline" id="line-355"><code>	name := plugin.Name()</code></span>
<span class="codeline" id="line-356"><code>	if _, ok := db.Plugins[name]; !ok {</code></span>
<span class="codeline" id="line-357"><code>		if err = plugin.Initialize(db); err == nil {</code></span>
<span class="codeline" id="line-358"><code>			db.Plugins[name] = plugin</code></span>
<span class="codeline" id="line-359"><code>		}</code></span>
<span class="codeline" id="line-360"><code>	} else {</code></span>
<span class="codeline" id="line-361"><code>		return ErrRegistered</code></span>
<span class="codeline" id="line-362"><code>	}</code></span>
<span class="codeline" id="line-363"><code></code></span>
<span class="codeline" id="line-364"><code>	return err</code></span>
<span class="codeline" id="line-365"><code>}</code></span>
</pre><pre id="footer">
<table><tr><td><img src="../../../png/go101-twitter.png"></td>
<td>The pages are generated with <a href="https://go101.org/article/tool-golds.html"><b>Golds</b></a> <i>v0.1.6</i>. (GOOS=darwin GOARCH=amd64)
<b>Golds</b> is a <a href="https://go101.org">Go 101</a> project and developed by <a href="https://tapirgames.com">Tapir Liu</a>.
PR and bug reports are welcome and can be submitted to <a href="https://github.com/go101/golds">the issue list</a>.
Please follow <a href="https://twitter.com/go100and1">@Go100and1</a> (reachable from the left QR code) to get the latest news of <b>Golds</b>.</td></tr></table
</pre>
</div></body></html>